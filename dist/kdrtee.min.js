(function(t,e){typeof exports==="object"&&typeof module!=="undefined"?module.exports=e():typeof define==="function"&&define.amd?define(e):t.KDTree=e()})(this,function(){"use strict";var t=function t(e){this.content=[];this.scoreFunction=e};t.prototype.push=function t(e){this.content.push(e);this.bubbleUp(this.content.length-1)};t.prototype.pop=function t(){var e=this.content;var n=e[0];var i=e.pop();if(e.length>0){e[0]=i;this.sinkDown(0)}return n};t.prototype.peek=function t(){return this.content[0]};t.prototype.remove=function t(e){var n=this;var i=this.content.length;var r=this.scoreFunction;var o=this.content;for(var a=0;a<i;a++){if(o[a]===e){var s=o.pop();if(a!==i-1){o[a]=s;if(r(s)<r(e)){n.bubbleUp(a)}else{n.sinkDown(a)}}return}}throw new Error("Node not found.")};t.prototype.size=function t(){return this.content.length};t.prototype.bubbleUp=function t(e){var n=this.content;var i=this.scoreFunction;var r=n[e];while(e>0){var o=Math.floor((e+1)/2)-1;var a=n[o];if(i(r)<i(a)){n[o]=r;n[e]=a;e=o}else{break}}};t.prototype.sinkDown=function t(e){var n=this;var i=this.content;var r=this.scoreFunction;var o=i.length;var a=i[e];var s=r(a);while(true){var l=(e+1)*2;var f=l-1;var h=null;var u=void 0,d=void 0;if(f<o){u=r(i[f]);if(u<s){h=f}}if(l<o){d=r(n.content[l]);if(d<(h===null?s:u)){h=l}}if(h){i[e]=i[h];i[h]=a;e=h}else{break}}};function e(t,e,n){if(n===void 0)n=null;return{data:t,parent:n,dimension:e,left:null,right:null}}var n=function t(e,n,i){this.dimensions=i;var r=[];for(var o=0,a=i.length;o<a;o++){var s=i[o];r.push(function(t,e){return t[s]-e[s]})}this._sorters=r;this.metric=n;if(!Array.isArray(e)){this.loadTree(e)}else{this.root=this.buildTree(e,0,null)}};n.prototype.buildTree=function t(n,i,r){var o=this.dimensions.length;var a=this._sorters;if(r===null){r=e(null,i%o,null)}var s=[r],l;var f=[n];while(l=s.pop()){var h=f.pop();var u=h.length;if(u===1){l.data=h}else{var d=Math.floor(u/2);var p=l.dimension;h.sort(a[p%o]);l.data=h[d];if(d>0){f.push(h.slice(0,d));l.left=e(null,p+1,l);s.push(l.left)}if(d<u-1){f.push(h.slice(d));l.right=e(null,p+1,l);s.push(l.right)}}}return r};n.prototype.loadTree=function t(e){this.root=e;n.restoreParent(this.root)};n.restoreParent=function t(e){if(e.left){e.left.parent=e;n.restoreParent(e.left)}if(e.right){e.right.parent=e;n.restoreParent(e.right)}};n.prototype.toJSON=function t(n){if(!n){n=this.root}var i=e(n.data,n.dimension,null);if(n.left){i.left=this.toJSON(n.left)}if(n.right){i.right=this.toJSON(n.right)}return i};n.prototype.innerSearch=function t(e,n,i){if(n===null){return i}var r=this.dimensions[n.dimension];if(e[r]<n.data[r]){return this.innerSearch(e,n.left,n)}else{return this.innerSearch(e,n.right,n)}};n.prototype._findNode=function t(e){var n=[this.root],i=null,r;while(n.length!==0){i=n.pop();r=i.dimension;if(e[r]<i.data[r]&&i.left){n.push(i.left)}else if(i.right){n.push(i.right)}}return i};n.prototype.insert=function t(n){var i=this._findNode(n);var r=this.dimensions;if(this.root===null){this.root=e(n,0,null);return this.root}var o=e(n,(i.dimension+1)%r.length,i);var a=r[i.dimension];if(n[a]<i.data[a]){i.left=o}else{i.right=o}return o};n.prototype.nodeSearch=function t(e,n){if(e===null){return null}if(e.data===n){return e}var i=this.dimensions[e.dimension];if(n[i]<e.data[i]){return this.nodeSearch(e.left,e.data)}else{return this.nodeSearch(e.right,e.data)}};n.prototype.findMin=function t(e,n){if(e===null){return null}var i=this.dimensions[n];if(e.dimension===n){if(e.left!==null){return this.findMin(e.left,n)}return e}var r=e.data[i];var o=this.findMin(e.left,n);var a=this.findMin(e.right,n);var s=e;if(o!==null&&o.data[i]<r){s=o}if(a!==null&&a.data[i]<s.data[i]){s=a}return s};n.prototype.removeNode=function t(e){var n,i;if(e.left===null&&e.right===null){if(e.parent===null){this.root=null;return}var r=dimensions[e.parent.dimension];if(e.data[r]<e.parent.data[r]){e.parent.left=null}else{e.parent.right=null}return}if(e.right!==null){n=this.findMin(e.right,e.dimension);i=n.data;this.removeNode(n);e.data=i}else{n=this.findMin(e.left,e.dimension);i=n.data;this.removeNode(n);e.right=e.left;e.left=null;e.data=i}};n.prototype.remove=function t(e){var n=this.nodeSearch(this.root,e);if(n){this.removeNode(n)}return e};n.saveNode=function t(e,n,i,r){i.push([e,n]);if(i.size()>r){i.pop()}};n.prototype.nearestSearch=function t(e,i,r,o){var a;var s=this.dimensions;var l=s[e.dimension];var f=this.metric(i,e.data);var h=[];var u,d,p;for(var v=0,c=s.length;v<c;v++){p=s[v];if(v===e.dimension){h[p]=i[p]}else{h[p]=e.data[p]}}var g=this.metric(h,e.data);if(e.right===null&&e.left===null){if(r.size()<o||f<r.peek()[1]){n.saveNode(e,f,r,o)}return}if(e.right===null){a=e.left}else if(e.left===null){a=e.right}else{if(i[l]<e.data[l]){a=e.left}else{a=e.right}}this.nearestSearch(a,i,r,o);if(r.size()<o||f<r.peek()[1]){n.saveNode(e,f,r,o)}if(r.size()<o||Math.abs(g)<r.peek()[1]){if(a===e.left){u=e.right}else{u=e.left}if(u!==null){this.nearestSearch(u,i,r,o)}}};n.prototype.nearest=function e(n,i,r){if(i===void 0)i=1;if(r===void 0)r=0;var o=new t(function(t){return-t[1]});if(r){for(var a=0;a<i;a++){o.push([null,r])}}if(this.root){this.nearestSearch(this.root,n,o,i)}var s=[],l=o.content;for(var f=0,h=Math.min(i,l.length);f<h;f++){if(l[f][0]){s.push([l[f][0].data,l[f][1]])}}console.log(s);return s};n.prototype.balanceFactor=function t(){function e(t){if(t===null){return 0}return Math.max(e(t.left),e(t.right))+1}function n(t){if(t===null){return 0}return n(t.left)+n(t.right)+1}return e(this.root)/(Math.log(n(this.root))/Math.log(2))};return n});
